{% extends "new/iit_base.html" %}
    
{% block title%}IIT Charts{% endblock title %}

{% block script %}
<script>
    let selectedCategory = 'OPEN';
    let selectedBranch = 'Mechanical Engineering';
    let selectedGender = 'Gender-Neutral';

    let branches = [];
    let rounds = ['Round 1','Round 2','Round 3','Round 4','Round 5','Round 6','Round 7'];
    let closingRanks = {};

    function handleButtonClick() {
        window.location.href = "{% url 'iit-list' %}";
    }

    function changeCategory(category) {
        document.getElementById("categoryDropdown").innerText = category;
        selectedCategory = category;
        updateclosingRanks();
    }

    function changeGender(gender) {
        document.getElementById("genderDropdown").innerText = gender;
        selectedGender = gender;
        updateclosingRanks();
    }

    function changeBranch(branch) {
        document.getElementById("branchDropdown").innerText = branch;
        selectedBranch = branch;
        updateclosingRanks();
    }

    // Load data
    var data = JSON.parse('{{ data|escapejs }}');
    for (let i = 0; i < data.length; i++) {
        let adm = data[i].fields;
        let academicProgramName = adm.academic_program_name;
        let branch = academicProgramName.split('(')[0].trim();
        if (!branches.includes(branch)) {
            branches.push(branch);
        }
    }

    function updateclosingRanks() {
        closingRanks = {};
        data.forEach((adm) => {
            let admFields = adm.fields;
            let year = admFields.year;
            let branch = admFields.academic_program_name.split('(')[0].trim();
            let gender = admFields.gender;
            let closingRank = admFields.closing_rank;

            if (
                admFields.seat_type === selectedCategory &&
                branch === selectedBranch &&
                ((selectedGender === 'Gender-Neutral' && (gender === '' || gender === 'Gender-Neutral')) || gender === selectedGender) 
            ) {
                if (!closingRanks.hasOwnProperty(year)) {
                    closingRanks[year] = [];
                }
                closingRanks[year].push(closingRank);
            }
        });
        updateChart();
    }

    let myChart;

    function updateChart() {
        let ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) {
            myChart.destroy();
        }

        let datasets = [];
        for (let year in closingRanks) {
            if (closingRanks.hasOwnProperty(year)) {
                let dataOther = closingRanks[year];
                let colour = getRandomColor();
                datasets.push({
                    label: `Closing Rank - ${year}`,
                    data: dataOther,
                    borderColor: colour,
                    backgroundColor: colour,
                    fill: false,
                    tension: 0.3
                });
            }
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: rounds,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12,
                                family: "'Poppins', sans-serif"
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Round',
                            font: { size: 14 }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Closing Rank',
                            font: { size: 14 }
                        },
                        beginAtZero: false
                    }
                }
            }
        });
    }

    // Random color generator
    function getRandomColor() {
        let letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    $(document).ready(function() {
        const branchDropdownMenu = document.getElementById("branchDropdownMenu");
        branchDropdownMenu.innerHTML = "";

        branches.forEach(function(branch) {
            const branchOption = document.createElement("a");
            branchOption.classList.add("dropdown-item");
            branchOption.href = "#";
            branchOption.textContent = branch;
            branchOption.onclick = function() {
                changeBranch(branch);
            };
            branchDropdownMenu.appendChild(branchOption);
        });

        updateclosingRanks();
    });
</script>
{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8fafc;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .card-header {
        border-radius: 12px 12px 0 0;
    }

    .dropdown-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .dropdown button, .btn-primary {
        font-size: 14px;
        padding: 8px 15px;
        border-radius: 6px;
    }

    .image-container {
        position: relative;
        width: 100%;
        max-width: 1000px;
        height: 450px;
        margin: 0 auto;
    }

    #myChart {
        width: 100% !important;
        height: 100% !important;
    }

    @media (max-width: 768px) {
        .image-container {
            height: 300px;
        }
    }
</style>

<div class="container mt-5">
    <div class="card">
        <div class="card-header text-center bg-primary text-white">
            <h3 class="mb-0">{{ institute_name }}</h3>
        </div>
        <div class="card-body">
            <h5 class="card-title text-center mb-4">Cut-off Ranks vs Rounds (2016â€“2023)</h5>
            
            <div class="dropdown-container">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="branchDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Mechanical Engineering
                    </button>
                    <div class="dropdown-menu" aria-labelledby="branchDropdown" id="branchDropdownMenu"></div>
                </div>                
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="categoryDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        OPEN
                    </button>
                    <div class="dropdown-menu" aria-labelledby="categoryDropdown">
                        <a class="dropdown-item" href="#" onclick="changeCategory('OPEN')">OPEN</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('EWS')">EWS</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('OBC-NCL')">OBC-NCL</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('SC')">SC</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('ST')">ST</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('OPEN (PwD)')">OPEN (PwD)</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('EWS (PwD)')">EWS (PwD)</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('OBC-NCL (PwD)')">OBC-NCL (PwD)</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('SC (PwD)')">SC (PwD)</a>
                        <a class="dropdown-item" href="#" onclick="changeCategory('ST (PwD)')">ST (PwD)</a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="genderDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Gender-Neutral
                    </button>
                    <div class="dropdown-menu" aria-labelledby="genderDropdown">
                        <a class="dropdown-item" href="#" onclick="changeGender('Gender-Neutral')">Gender-Neutral</a>
                        <a class="dropdown-item" href="#" onclick="changeGender('Female-only (including Supernumerary)')">Female</a>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="handleButtonClick()">Go to IIT List</button>
            </div>

            <div class="image-container">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}
